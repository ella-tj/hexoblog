<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="zu1k"><meta name="subtitle" content="an interest-driven blog"><meta name="description" content="Hi, I'm zu1k, a boy dreaming of traveling around the world. "><meta name="keywords" content="zu1k,lgf,zuik,lgf.im"><title>学习Linux中的SUID机制 | zu1k</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script src="/js/script.js"></script><script src="/js/tocbot.min.js"></script><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="zu1k" type="application/atom+xml"><link rel="alternate" href="/rss2.xml" title="zu1k" type="application/rss+xml"></head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">ZU1K</a></div><div class="menu navbar-right"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Category</a> <a class="menu-item" href="/tag">Tag</a> <a class="menu-item" href="/about">About</a> <a class="menu-item" href="/feed">Feed</a> <input id="switch_default" type="checkbox" class="switch_default"> <label for="switch_default" class="toggleBtn"></label></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">ZU1K</a><a id="mobile-toggle-theme">·&nbsp;Light</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Category</a> <a class="menu-item" href="/tag">Tag</a> <a class="menu-item" href="/about">About</a> <a class="menu-item" href="/feed">Feed</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a> <a onclick="go_top()">Back to top</a> <a onclick="go_bottom()">Go to bottom</a></div></div><script>function expand_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","collapse_toc()"),o.innerHTML="Collapse all"}function collapse_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","expand_toc()"),o.innerHTML="Expand all"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready(function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})})</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">学习Linux中的SUID机制</h1><div class="post-meta"><span class="post-time"><a href="#">2020-03-30&nbsp;&nbsp;11:36</a> </span><span class="post-category">Category: <a href="/categories/coding/">coding</a> </span><span class="post-busuanzi"><span id="busuanzi_container_page_pv">Read: <span id="busuanzi_value_page_pv"></span></span></span></div></header><div class="post-content"><h2 id="什么是SUID"><a href="#什么是SUID" class="headerlink" title="什么是SUID"></a>什么是SUID</h2><p>SUID简称位，英文全称是Set owner User ID up on execution，它是一种特殊的文件权限，能够让用户(如Bob)用其他用户(如root用户)的权限运行一个程序，而不需要用sudo进行临时提权</p><p>同一类的还有SGID，就不详细说了，原理与SUID一样，就以SUID为例</p><p>在一个程序执行的时候会有三个ID状态，在深入学习SUID之前必须能够区分下面三种ID：</p><ul><li>Real User ID</li><li>Effective User ID</li><li>Saved User ID</li></ul><p><code>Real User ID</code> 是执行这个程序的用户的真实ID，是已用户login时候的ID为准</p><p><code>Effective User ID</code> 是程序执行过程中使用权限时真正起作用的用户ID，操作系统在检查一个程序有没有某个权限的时候会看这个ID</p><p><code>Saved User ID</code> 是程序临时提权时需要保存的先前的用户ID，等提权结束后需要回退到这个用户ID</p><h2 id="SUID的作用"><a href="#SUID的作用" class="headerlink" title="SUID的作用"></a>SUID的作用</h2><p>如果用户user2有另一个用户user1的程序的执行权限，并且user1给这个程序设置了SUID位，那么user2就可以用user1的权限来执行这个程序</p><p>简单来说，SUID能够让用户(如Bob)用其他用户(如root用户)的权限运行一个程序，而不需要用sudo进行临时提权</p><p>举个例子：</p><p>所有用户的密码保存在 <code>/etc/shadow</code> 文件中，但是这个文件只有root用户能够进行写操作</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># ls -l /etc/shadow</span></span><br><span class="line">-rw-r----- 1 root shadow 1639 Jan 27 12:50 /etc/shadow</span><br></pre></td></tr></table></figure><p>那如果普通用户想要修改自己的密码，是否需要让root用户帮着修改呢？</p><p>显然不需要，修改密码用到了 <code>/usr/bin/passwd</code> 这个程序，我们来看一下它的权限</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@kali:~<span class="comment"># ls -l /usr/bin/passwd</span></span><br><span class="line">-rwsr-xr-x 1 root root 63944 Dec 20 10:39 /usr/bin/passwd</span><br></pre></td></tr></table></figure><p>可以看到，这个程序的所有者是root用户，但是所有用户都有执行权限，并且设置了s位（怎么看出来的后面会说）</p><p>这样SUID机制就会在程序执行的时候发生作用，让普通用户可以用root权限修改<code>/etc/shadow</code>文件</p><p>SUID机制的存在使程序权限的控制更加方便，用户可以执行某个程序而不需要登录到程序拥有者的账号</p><h2 id="如何使用SUID"><a href="#如何使用SUID" class="headerlink" title="如何使用SUID"></a>如何使用SUID</h2><h3 id="查看SUID"><a href="#查看SUID" class="headerlink" title="查看SUID"></a>查看SUID</h3><p>通过命令 <code>ls -l</code> 即可看到文件的详细信息，包括权限表 <code>-rwxrwxrwx</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">-   rwx   rwx   rwx</span><br><span class="line"></span><br><span class="line">第一位是文件类型，-就是普通文件，d代表目录，l代表链接文件，还有一些其他类型的文件不详细说了</span><br><span class="line"></span><br><span class="line">后面的9位可以分成三组，分别表示所有者权限、同组内用户权限，组外其他用户权限</span><br><span class="line"></span><br><span class="line">每一组都有三位，r 代表有读取权限，w 代表有写入权限，x 代表有执行权限，如果是 _ 就代表没有相应的权限</span><br><span class="line"></span><br><span class="line">如果文件所有者权限的 x 换成 s 就代表设置了SUID</span><br><span class="line"></span><br><span class="line">同理如果组内用户权限的 x 换成了 s 就代表设置了SGID</span><br></pre></td></tr></table></figure><h3 id="设置SUID"><a href="#设置SUID" class="headerlink" title="设置SUID"></a>设置SUID</h3><p>使用 <code>chmod 4000 filename</code> 可以设置SUID位</p><p>使用 <code>chmod 2000 filename</code> 可以设置SGID位</p><p>使用 <code>chmod 6000 filename</code> 可以同时设置SGID和SUID位</p><blockquote><p>注意: 2000\4000\6000都是不完整的权限，正常使用应该将000替换为相应的权限，例如 4755</p></blockquote><h3 id="取消SUID"><a href="#取消SUID" class="headerlink" title="取消SUID"></a>取消SUID</h3><p>使用 <code>chmod 755 filename</code> 可以取消SGID和SUID位</p><p>或者 <code>chmod u-s filename</code> or <code>chmod g-s filename</code> 也可以</p><h2 id="SUID提权"><a href="#SUID提权" class="headerlink" title="SUID提权"></a>SUID提权</h2><p>因为SUID位让程序在执行的时候有了所有者的权限，所以可以利用这点来提权</p><p>示例：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 进入nmap的交互模式</span></span><br><span class="line">nmap --interactive</span><br><span class="line"><span class="comment"># 执行sh，提权成功</span></span><br><span class="line">!sh</span><br></pre></td></tr></table></figure><p>详细介绍见： <a target="_blank" rel="noopener" href="https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html">https://www.leavesongs.com/PENETRATION/linux-suid-privilege-escalation.html</a></p><h2 id="SUID在脚本中失效"><a href="#SUID在脚本中失效" class="headerlink" title="SUID在脚本中失效"></a>SUID在脚本中失效</h2><p>假如user1用 <code>chmod 4777 /home/user1/script.sh</code> 命令给<code>script.sh</code>脚本设置SUID位，登录user2后执行这个脚本提示没有权限</p><p>这是因为SUID位只对编译过的可执行程序起作用，sh脚本的实际执行程序是sh或者bash之类，如果它们在执行的时候并不会检查脚本文件的SUID位，那就不会起作用了</p><p>Perl执行器会检查perl脚本的suid位，所以可以给pl脚本设置suid位</p></div><section class="post-tags"><div><span>Tags:</span> <span class="tag"><a href="/tags/linux/">#linux</a> <a href="/tags/coding/">#coding</a> <a href="/tags/suid/">#suid</a></span></div><div><a href="javascript:window.history.back();">back</a> <span>· </span><a href="/">home</a></div></section><section class="post-nav"><a class="prev" rel="prev" href="/2020/bake-sweet-potato.html">烤红薯</a> <a class="next" rel="next" href="/2020/set-proxy-for-git.html">给git设置代理</a></section></article></div></div><footer id="footer" class="footer"><div class="copyright"><span>© zu1k | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span></div><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></footer></div></body></html>